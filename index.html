<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Login CBT</title>
<style>
*{ box-sizing:border-box; font-family:Arial, Helvetica, sans-serif }
body{ margin:0; height:100vh; display:flex; justify-content:center; align-items:center; background:linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.35)), url("https://raw.githubusercontent.com/airnetcso/eps/main/image/bg1.jpg") center/cover no-repeat; }
.login-box{ width:340px; background:rgba(255,255,255,.3); padding:30px 25px; text-align:center; backdrop-filter:blur(6px); border-radius:10px; }
.login-box h2{ margin-bottom:20px; color:#fff; }
input, select, button{ width:100%; padding:12px; margin-bottom:12px; font-size:14px; border-radius:6px; border:none; }
input, select{ outline:none; }
button{ background:#2563eb; color:#fff; cursor:pointer; font-weight:bold; }
button:hover{ background:#1e40af; }
#error-msg{ color:#ff0000; font-weight:bold; margin-top:10px; font-size:13px; }
.copyright{ position:fixed; bottom:12px; width:100%; text-align:center; font-size:12px; color:rgba(255,255,255,0.85); letter-spacing:0.5px; }
</style>
</head>
<body>
<div class="login-box">
  <h2>LOGIN UBT</h2>
  <input id="username" placeholder="Username / 이름">
  <input id="password" type="password" placeholder="Password / 비밀번호">
  <select id="paket">
    <option value="1">TRYOUT 01</option>
    <option value="2">TRYOUT 02</option>
    <option value="3">TRYOUT 03</option>
  </select>
  <button onclick="login()">LOGIN / 로그인</button>
  <div id="error-msg"></div>
</div>
<div class="copyright">
  © 2026 Denzuka - Kim Jongun. All Rights Reserved.
</div>

<script>
// URL Google Sheet /koka
const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycby4n_2wq6NSRDcKZ5h_EK52P6unhy4hcDKg_svaaXjN5K2kPQXOEYouvEtnQVIKMhHamA/exec";

function checkStorage(){
  try{ localStorage.setItem("test","ok"); localStorage.removeItem("test"); return true; }catch(e){ return false; }
}

const users = [
  {username:"siswa01",password:"12345",role:"user"},
  {username:"windi",password:"Windi2000",role:"user"},
  {username:"rismaya97",password:"bahasakorea",role:"user"},
  {username:"sita77",password:"minyooki",role:"user"},
  {username:"Aini185",password:"Doraemon",role:"user"},
  {username:"Hangeulfei",password:"studykorea02",role:"user"},
  {username:"Hamdan106",password:"Fukuo106",role:"user"},
  {username:"Heri",password:"heri99",role:"user"},
  {username:"admin",password:"admin123",role:"admin"}
];

function login(){
  const err = document.getElementById("error-msg");
  err.innerText = "";
  if(!checkStorage()){ err.innerText = "Browser memblokir localStorage. Gunakan mode normal."; return; }

  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  const paket = document.getElementById("paket").value;
  const user = users.find(x => x.username === u && x.password === p);

  if(!user){ err.innerText = "Username atau password salah!"; return; }

  if(Number(paket) > 1){
    const results = JSON.parse(localStorage.getItem("results") || "[]");
    const prev = results.find(r => r.name === u && Number(r.paket) === Number(paket) - 1);
    if(!prev || Number(prev.score) < 80){ err.innerText = "Harus lulus paket sebelumnya dengan nilai minimal 80"; return; }
  }

  localStorage.setItem("login","true");
  localStorage.setItem("user",u);
  localStorage.setItem("paket",paket);

  if(user.role === "admin") location.href = "https://airnetcso.github.io/admin/";
  else location.href = "dashboard.html";
}

// === Fungsi kirim skor ke Google Sheet /koka ===
function sendScoreToSheet(username, paket, score){
  const data = {
    username: username,
    kodeSoal: "TRYOUT " + ("0"+paket).slice(-2),
    jenisAplikasi: "UBT",
    skor: score,
    persentase: Math.round(score), // bisa disesuaikan
    catatan: "" // bisa dikosongkan atau diisi data tambahan
  };
  fetch(SPREADSHEET_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(res => console.log("Skor berhasil dikirim:", res))
  .catch(e => console.error("⚠️ Gagal mengirim skor ke Google Sheet. Cek console.", e));
}

// === Override localStorage.setItem untuk kirim skor otomatis ===
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value){
  originalSetItem.apply(this, arguments);
  if(key === "results"){ // setiap kali quiz selesai simpan results
    try{
      const allResults = JSON.parse(value);
      const latest = allResults[allResults.length-1];
      if(latest && latest.name && latest.score !== undefined){
        sendScoreToSheet(latest.name, latest.paket, latest.score);
      }
    }catch(e){ console.error("Error sync skor otomatis:", e); }
  }
};
</script>
</body>
</html>
