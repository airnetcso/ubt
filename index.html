<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>UBT CBT</title>
<style>
/* ===================== STYLE LOGIN / DASHBOARD ===================== */
*{ box-sizing:border-box; font-family:Arial, Helvetica, sans-serif; }
body{ margin:0; min-height:100vh; background:#f0f0f0; }
header.header{ display:flex; justify-content:space-between; align-items:center; padding:12px; background:#2563eb; color:#fff; }
.header .box{ background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:6px; cursor:pointer; }
.content.two-col{ display:flex; gap:12px; padding:12px; }
.col{ flex:1; }
.section-box{ background:#2563eb; color:#fff; padding:6px; border-radius:6px; margin-bottom:6px; text-align:center; font-weight:bold; }
.grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
.qbox{ padding:12px; background:#fff; border:1px solid #ccc; border-radius:6px; cursor:pointer; text-align:center; font-weight:bold; }
.qbox.done{ background:#6ee7b7; }
.question-page{ display:flex; gap:12px; padding:12px; }
.col-left{ flex:1; }
.col-right{ flex:2; }
.dialog-box{ background:#e2e8f0; padding:12px; border-radius:6px; margin:12px 0; }
.dialog-center{ text-align:center; }
#answers button{ width:40px; height:40px; border-radius:6px; font-weight:bold; }
.nav-buttons{ display:flex; justify-content:space-between; padding:12px; }
button:hover{ opacity:0.85; cursor:pointer; }
</style>
</head>
<body>

<!-- ===================== LOGIN PAGE ===================== -->
<div class="login-box" id="loginBox" style="max-width:340px;margin:30px auto;padding:30px;text-align:center;background:rgba(255,255,255,.3);backdrop-filter:blur(6px);border-radius:10px;">
  <h2 style="margin-bottom:20px;color:#fff;">LOGIN UBT</h2>
  <input id="username" placeholder="Username / 이름" style="width:100%;padding:12px;margin-bottom:12px;font-size:14px;border-radius:6px;border:none;outline:none;">
  <input id="password" type="password" placeholder="Password / 비밀번호" style="width:100%;padding:12px;margin-bottom:12px;font-size:14px;border-radius:6px;border:none;outline:none;">
  <select id="paket" style="width:100%;padding:12px;margin-bottom:12px;font-size:14px;border-radius:6px;border:none;outline:none;">
    <option value="1">TRYOUT 01</option>
    <option value="2">TRYOUT 02</option>
    <option value="3">TRYOUT 03</option>
  </select>
  <button onclick="login()" style="width:100%;padding:12px;background:#2563eb;color:#fff;font-weight:bold;border:none;border-radius:6px;">LOGIN / 로그인</button>
  <div id="error-msg" style="color:#ff0000;font-weight:bold;margin-top:10px;font-size:13px;"></div>
</div>

<!-- ===================== DASHBOARD ===================== -->
<header class="header" id="dashboardHeader" style="display:none;">
  <div>
    <span id="user"></span>
    <button id="submitBtn" class="box" onclick="manualSubmit()">SUBMIT</button>
  </div>
  <div id="timerBox" class="box">50:00</div>
</header>

<div class="content two-col" id="dashboardContent" style="display:none;">
  <div class="col">
    <div class="section-box listening">SOAL MENDENGAR / 듣기문제</div>
    <div class="grid" id="listen"></div>
  </div>
  <div class="col">
    <div class="section-box reading">SOAL MEMBACA / 읽기문제</div>
    <div class="grid" id="read"></div>
  </div>
</div>

<!-- ===================== QUESTION PAGE ===================== -->
<div class="question-page" id="questionPage" style="display:none;">
  <div class="col-left" id="answers"></div>
  <div class="col-right" id="questionBox"></div>
</div>

<div class="nav-buttons" id="navButtons" style="display:none;">
  <button onclick="prevQuestion()">SEBELUMNYA</button>
  <button onclick="back()">KEMBALI</button>
  <button onclick="nextQuestion()">BERIKUTNYA</button>
</div>

<script>
// ===================== CONFIG =====================
const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbyfCZ5YNQHDLyKWatqj-diL8tXRRwXBKfJaaYMqcqoShABYy4Gx6QpexPOB_MkZwpIwLw/exec";
const users = [
  {username:"uus",password:"123"},
  {username:"hanarizka",password:"Nungkihana24!"},
  {username:"Heri",password:"heri99"},
  {username:"siswa01",password:"12345"},
  {username:"windi",password:"Windi2000"},
  {username:"rismaya97",password:"bahasakorea"},
  {username:"wantikas",password:"200022",role:"admin"},
  {username:"Fikrisurya",password:"464646"},
  {username:"Mutiara2003",password:"Mutiara14"},
  {username:"sita77",password:"minyooki"},
  {username:"Aini185",password:"Doraemon"},
  {username:"Hangeulfei",password:"studykorea02"},
  {username:"Hamdan186",password:"Fukuo106"},
  {username:"admin",password:"admin123",role:"admin"}
];

// ===================== LOCAL STORAGE CHECK =====================
function checkStorage(){ try{ localStorage.setItem("test","ok"); localStorage.removeItem("test"); return true; }catch(e){ return false; }}

// ===================== LOGIN =====================
function login(){
  const err = document.getElementById("error-msg");
  err.innerText = "";
  if(!checkStorage()){ err.innerText = "Browser memblokir localStorage. Gunakan mode normal."; return; }

  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  const paket = document.getElementById("paket").value;

  const user = users.find(x => x.username === u && x.password === p);
  if(!user){ err.innerText="Username atau password salah!"; return; }

  if(Number(paket)>1){
    const results = JSON.parse(localStorage.getItem("results") || "[]");
    const prev = results.find(r=>r.name===u && Number(r.paket)===Number(paket)-1);
    if(!prev || Number(prev.score)<80){ err.innerText="Harus lulus paket sebelumnya dengan nilai minimal 80"; return; }
  }

  localStorage.setItem("login","true");
  localStorage.setItem("user",u);
  localStorage.setItem("paket",paket);

  if(user.role==="admin"){ location.href="https://airnetcso.github.io/admin/"; return; }

  document.getElementById("loginBox").style.display="none";
  document.getElementById("dashboardHeader").style.display="flex";
  document.getElementById("dashboardContent").style.display="flex";
  init();
}

// ===================== QUIZ LOGIC =====================
let questions=[];
let answered=JSON.parse(localStorage.getItem("answered")||"{}");
let currentIndex=0;
const paket = localStorage.getItem("paket")||"1";
const soalURL = `https://airnetcso.github.io/ubt/soal/soal${paket}.json`;

async function loadSoal(){
  try{
    const res=await fetch(soalURL);
    if(!res.ok) throw new Error("Gagal memuat soal");
    questions = await res.json();
    buildGrid();
  }catch(e){ console.error(e); alert("Gagal memuat soal. Periksa koneksi internet Anda."); }
}

function buildGrid(){
  const L=document.getElementById("listen");
  const R=document.getElementById("read");
  if(!L||!R) return;
  L.innerHTML=""; R.innerHTML="";
  questions.forEach(q=>{
    const box=document.createElement("div");
    box.className="qbox"; box.textContent=q.id;
    if(answered[q.id]) box.classList.add("done");
    box.onclick=()=>{ localStorage.setItem("current",q.id); showQuestionPage(); };
    (q.type==="listening"?L:R).appendChild(box);
  });
}

function showQuestionPage(){
  document.getElementById("dashboardHeader").style.display="none";
  document.getElementById("dashboardContent").style.display="none";
  document.getElementById("questionPage").style.display="flex";
  document.getElementById("navButtons").style.display="flex";
  loadQuestionPage();
}

function loadQuestionPage(){
  const box=document.getElementById("questionBox");
  const ans=document.getElementById("answers");
  if(!box||!ans) return;
  const id=Number(localStorage.getItem("current"));
  const idx=questions.findIndex(q=>q.id===id); currentIndex=idx<0?0:idx;
  const q=questions[currentIndex];
  box.innerHTML=""; ans.innerHTML="";

  const h=document.createElement("h3");
  h.textContent=`${q.id}. ${q.question.split("\n\n")[0]}`;
  box.appendChild(h);

  if(q.question.includes("\n\n")){
    const d=document.createElement("div");
    d.className="dialog-box";
    if(q.id===37||q.id===38) d.classList.add("dialog-center");
    d.textContent=q.question.split("\n\n").slice(1).join("\n\n");
    box.appendChild(d);
  }

  if(q.audio){
    const container=document.createElement("div");
    container.style.margin="25px 0"; container.style.textAlign="center";
    const audio=document.createElement("audio"); audio.controls=true; audio.preload="auto"; audio.src=q.audio;
    audio.style.width="100%"; audio.style.maxWidth="420px"; audio.style.display="block"; audio.style.margin="0 auto";
    container.appendChild(audio); box.appendChild(container);
  }

  if(q.image){
    const i=document.createElement("img"); i.src=q.image; i.style.maxWidth="100%"; i.style.height="auto"; i.style.display="block"; i.style.margin="20px auto";
    box.appendChild(i);
  }

  q.options.forEach((option,i)=>{
    const b=document.createElement("button"); b.textContent=i+1; if(answered[q.id]===i+1) b.classList.add("selected");
    b.onclick=()=>{ answered[q.id]=i+1; localStorage.setItem("answered",JSON.stringify(answered)); buildGrid(); loadQuestionPage(); };
    const row=document.createElement("div"); row.style.display="flex"; row.style.alignItems="center"; row.style.gap="12px"; row.style.margin="12px 0";
    row.appendChild(b); const text=document.createElement("span"); text.textContent=option; row.appendChild(text); ans.appendChild(row);
  });
}

function nextQuestion(){ if(currentIndex+1<questions.length){ localStorage.setItem("current",questions[currentIndex+1].id); loadQuestionPage(); } }
function prevQuestion(){ if(currentIndex>0){ localStorage.setItem("current",questions[currentIndex-1].id); loadQuestionPage(); } }
function back(){ localStorage.removeItem("time"); document.getElementById("dashboardHeader").style.display="flex"; document.getElementById("dashboardContent").style.display="flex"; document.getElementById("questionPage").style.display="none"; document.getElementById("navButtons").style.display="none"; }

let time=Number(localStorage.getItem("time"))||50*60;
setInterval(()=>{
  if(time<=0){ finish(); return; } time--; localStorage.setItem("time",time);
  const t=document.getElementById("timerBox"); if(t){ const m=String(Math.floor(time/60)).padStart(2,"0"); const s=String(time%60).padStart(2,"0"); t.textContent=`${m}:${s}`; }
},1000);

function manualSubmit(){ if(confirm("Yakin ingin submit sekarang?")) finish(); }

function calculateScore(){ let correct=0; questions.forEach(q=>{ if(answered[q.id]===q.answer) correct++; }); return correct*2.5; }

function sendScoreToSheet(username,paket,score){
  const totalSoal=100; const persentase=Math.round((score/totalSoal)*100);
  fetch(SPREADSHEET_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ username:username||"Anonymous", kodeSoal:"TRYOUT "+("0"+paket).slice(-2), jenisAplikasi:"UBT", skor:score, persentase:persentase, catatan:"" })
  }).then(r=>r.json()).then(d=>console.log("Data berhasil dikirim ke Sheet:",d))
  .catch(err=>{ console.warn("POST gagal, fallback GET:",err); const params=new URLSearchParams({ username:username||"Anonymous", kodeSoal:"TRYOUT "+("0"+paket).slice(-2), jenisAplikasi:"UBT", skor:score, persentase:persentase, catatan:"" }); window.open(SPREADSHEET_URL+"?"+params.toString(),"_blank"); });
}

function finish(){
  const score=calculateScore();
  const results=JSON.parse(localStorage.getItem("results")||"[]");
  results.push({ name:localStorage.getItem("user"), paket:`${paket}`, score:score, time:document.getElementById("timerBox")?.innerText||"00:00", date:new Date().toLocaleString("id-ID") });
  localStorage.setItem("results",JSON.stringify(results));
  sendScoreToSheet(localStorage.getItem("user"),paket,score);

  localStorage.removeItem("login"); localStorage.removeItem("user"); localStorage.removeItem("paket"); localStorage.removeItem("answered"); localStorage.removeItem("time"); localStorage.removeItem("current");
  alert(`Ujian selesai!\nNilai Anda: ${score}`);
  location.href="index.html";
}

// ===================== INIT =====================
async function init(){ await loadSoal(); if(document.getElementById("listen")) buildGrid(); if(document.getElementById("questionBox")) loadQuestionPage(); }

</script>
</body>
</html>
