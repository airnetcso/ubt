<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UBT All-in-One</title>
<style>
/* =================== GLOBAL =================== */
*{box-sizing:border-box;font-family:Arial, Helvetica, sans-serif;margin:0;padding:0;}
body{min-height:100vh;background:#f2f2f2;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;}
.hidden{display:none;}
button{cursor:pointer;}
/* =================== LOGIN =================== */
.login-box{
  width:340px;
  background:rgba(255,255,255,.3);
  padding:30px 25px;
  text-align:center;
  backdrop-filter:blur(6px);
  border-radius:10px;
  margin-top:80px;
}
.login-box h2{margin-bottom:20px;color:#000;}
.login-box input, .login-box select, .login-box button{
  width:100%;padding:12px;margin-bottom:12px;font-size:14px;border-radius:6px;border:none;
}
.login-box input, .login-box select{outline:none;}
.login-box button{background:#2563eb;color:#fff;font-weight:bold;}
.login-box button:hover{background:#1e40af;}
#error-msg{color:red;font-weight:bold;margin-top:10px;font-size:13px;}
/* =================== DASHBOARD =================== */
.header{width:100%;display:flex;justify-content:space-between;padding:10px 20px;background:#2563eb;color:#fff;position:sticky;top:0;z-index:100;}
.header .top-right{display:flex;gap:12px;align-items:center;}
.header .box{padding:6px 12px;background:#fff;color:#2563eb;border-radius:6px;font-weight:bold;}
.content{display:flex;gap:20px;width:95%;max-width:1200px;margin:20px auto;}
.col{flex:1;}
.section-box{background:#2563eb;color:#fff;padding:10px;border-radius:6px;margin-bottom:10px;text-align:center;font-weight:bold;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:6px;}
.qbox{background:#eee;padding:8px;text-align:center;border-radius:4px;cursor:pointer;}
.qbox.done{background:#4ade80;color:#fff;font-weight:bold;}
/* =================== QUESTION =================== */
.question-page{display:flex;gap:20px;width:95%;max-width:1200px;margin:20px auto;}
.col-left{flex:1;}
.col-right{flex:2;}
.dialog-box{background:#f3f3f3;padding:10px;margin:10px 0;border-radius:6px;}
.dialog-center{text-align:center;}
.nav-buttons{display:flex;justify-content:center;gap:12px;margin-bottom:30px;}
.nav-buttons button{padding:10px 15px;background:#2563eb;color:#fff;border:none;border-radius:6px;font-weight:bold;}
.nav-buttons button:hover{background:#1e40af;}
</style>
</head>
<body>

<!-- =================== LOGIN PAGE =================== -->
<div id="loginPage" class="login-box">
  <h2>LOGIN UBT</h2>
  <input id="username" placeholder="Username / 이름">
  <input id="password" type="password" placeholder="Password / 비밀번호">
  <select id="paket">
    <option value="1">TRYOUT 01</option>
    <option value="2">TRYOUT 02</option>
    <option value="3">TRYOUT 03</option>
  </select>
  <button onclick="login()">LOGIN / 로그인</button>
  <div id="error-msg"></div>
</div>

<!-- =================== DASHBOARD =================== -->
<div id="dashboard" class="hidden">
  <header class="header">
    <div><button class="box" onclick="manualSubmit()">SUBMIT</button></div>
    <div id="user"></div>
    <div class="top-right">
      <div id="timerBox" class="box">50:00</div>
    </div>
  </header>
  <div class="content">
    <div class="col">
      <div class="section-box listening">SOAL MENDENGAR / 듣기문제</div>
      <div class="grid" id="listen"></div>
    </div>
    <div class="col">
      <div class="section-box reading">SOAL MEMBACA / 읽기문제</div>
      <div class="grid" id="read"></div>
    </div>
  </div>
</div>

<!-- =================== QUESTION PAGE =================== -->
<div id="questionPage" class="question-page hidden">
  <div class="col-left" id="answers"></div>
  <div class="col-right" id="questionBox"></div>
</div>
<div class="nav-buttons hidden" id="navButtons">
  <button onclick="prevQuestion()">SEBELUMNYA</button>
  <button onclick="back()">KEMBALI</button>
  <button onclick="nextQuestion()">BERIKUTNYA</button>
</div>

<script>
/* =================== GLOBAL =================== */
let questions = [];
let answered = JSON.parse(localStorage.getItem("answered") || "{}");
let currentIndex = 0;
const paket = localStorage.getItem("paket") || "1";
const soalURL = `https://airnetcso.github.io/ubt/soal/soal${paket}.json`;
const SPREADSHEET_URL = "const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbyfCZ5YNQHDLyKWatqj-diL8tXRRwXBKfJaaYMqcqoShABYy4Gx6QpexPOB_MkZwpIwLw/exec";
";

const users = [
  {username:"siswa01",password:"12345"},
  {username:"windi",password:"Windi2000"},
  {username:"rismaya97",password:"bahasakorea"},
  {username:"sita77",password:"minyooki"},
  {username:"Aini185",password:"Doraemon"},
  {username:"Hangeulfei",password:"studykorea02"},
  {username:"Hamdan106",password:"Fukuo106"},
  {username:"Heri",password:"heri99"},
  {username:"admin",password:"admin123",role:"admin"}
];

function checkStorage(){try{localStorage.setItem("test","ok");localStorage.removeItem("test");return true;}catch(e){return false;}}

/* =================== LOGIN =================== */
function login(){
  const err = document.getElementById("error-msg");
  err.innerText = "";
  if(!checkStorage()){ err.innerText = "Browser memblokir localStorage. Gunakan mode normal."; return; }

  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value.trim();
  const paket = document.getElementById("paket").value;
  const user = users.find(x=>x.username===u && x.password===p);
  if(!user){err.innerText="Username atau password salah!";return;}

  if(Number(paket)>1){
    const results = JSON.parse(localStorage.getItem("results")||"[]");
    const prev = results.find(r=>r.name===u && Number(r.paket)===Number(paket)-1);
    if(!prev || Number(prev.score)<80){err.innerText="Harus lulus paket sebelumnya dengan nilai minimal 80";return;}
  }

  localStorage.setItem("login","true");
  localStorage.setItem("user",u);
  localStorage.setItem("paket",paket);

  document.getElementById("loginPage").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
  document.getElementById("user").innerText = u;
  loadSoal();
}

/* =================== LOAD SOAL =================== */
async function loadSoal(){
  try{
    const res = await fetch(soalURL);
    if(!res.ok) throw new Error("Gagal memuat soal");
    questions = await res.json();
    buildGrid();
  }catch(e){console.error(e);alert("Gagal memuat soal. Periksa koneksi internet Anda.");}
}

/* =================== DASHBOARD GRID =================== */
function buildGrid(){
  const L=document.getElementById("listen");
  const R=document.getElementById("read");
  if(!L||!R)return;
  L.innerHTML="";R.innerHTML="";
  questions.forEach(q=>{
    const box=document.createElement("div");
    box.className="qbox";box.textContent=q.id;
    if(answered[q.id]) box.classList.add("done");
    box.onclick=()=>{currentIndex=questions.findIndex(qq=>qq.id===q.id);showQuestion();};
    (q.type==="listening"?L:R).appendChild(box);
  });
}

/* =================== QUESTION PAGE =================== */
function showQuestion(){
  const q=document.getElementById("questionPage");
  const a=document.getElementById("answers");
  const b=document.getElementById("questionBox");
  const nav=document.getElementById("navButtons");
  document.getElementById("dashboard").classList.add("hidden");
  q.classList.remove("hidden"); nav.classList.remove("hidden");
  a.innerHTML="";b.innerHTML="";

  const ques = questions[currentIndex];

  const h = document.createElement("h3");
  h.textContent=`${ques.id}. ${ques.question.split("\n\n")[0]}`;
  b.appendChild(h);

  if(ques.question.includes("\n\n")){
    const d=document.createElement("div");
    d.className="dialog-box";
    if(ques.id===37||ques.id===38)d.classList.add("dialog-center");
    d.textContent=ques.question.split("\n\n").slice(1).join("\n\n");
    b.appendChild(d);
  }

  if(ques.audio){
    const c=document.createElement("div");
    c.style.margin="25px 0"; c.style.textAlign="center";
    const audio=document.createElement("audio");
    audio.controls=true; audio.preload="auto"; audio.src=ques.audio;
    audio.style.width="100%"; audio.style.maxWidth="420px"; audio.style.display="block"; audio.style.margin="0 auto";
    c.appendChild(audio); b.appendChild(c);
  }

  if(ques.image){
    const i=document.createElement("img");
    i.src=ques.image; i.style.maxWidth="100%"; i.style.height="auto"; i.style.display="block"; i.style.margin="20px auto";
    b.appendChild(i);
  }

  ques.options.forEach((opt,i)=>{
    const btn=document.createElement("button"); btn.textContent=i+1;
    if(answered[ques.id]===i+1) btn.classList.add("selected");
    btn.onclick=()=>{
      answered[ques.id]=i+1;
      localStorage.setItem("answered",JSON.stringify(answered));
      buildGrid();
      showQuestion();
    };
    const row=document.createElement("div"); row.style.display="flex"; row.style.alignItems="center"; row.style.gap="12px"; row.style.margin="12px 0";
    row.appendChild(btn); const text=document.createElement("span"); text.textContent=opt; row.appendChild(text);
    a.appendChild(row);
  });
}

/* =================== NAVIGASI =================== */
function nextQuestion(){if(currentIndex+1<questions.length){currentIndex++;showQuestion();}}
function prevQuestion(){if(currentIndex>0){currentIndex--;showQuestion();}}
function back(){document.getElementById("questionPage").classList.add("hidden");document.getElementById("navButtons").classList.add("hidden");document.getElementById("dashboard").classList.remove("hidden");}

/* =================== TIMER =================== */
let time=Number(localStorage.getItem("time"))||50*60;
setInterval(()=>{
  if(time<=0){finish();return;}
  time--; localStorage.setItem("time",time);
  const t=document.getElementById("timerBox");
  if(t){const m=String(Math.floor(time/60)).padStart(2,"0"); const s=String(time%60).padStart(2,"0"); t.textContent=`${m}:${s}`;}
},1000);

/* =================== SUBMIT =================== */
function manualSubmit(){if(confirm("Yakin ingin submit sekarang?")) finish();}
function calculateScore(){let correct=0;questions.forEach(q=>{if(answered[q.id]===q.answer) correct++;}); return correct*2.5;}
function finish(){
  const score = calculateScore();
  const results = JSON.parse(localStorage.getItem("results")||"[]");
  results.push({
    name:localStorage.getItem("user"),
    paket:paket,
    score:score,
    time:document.getElementById("timerBox")?.innerText||"00:00",
    date:new Date().toLocaleString("id-ID")
  });
  localStorage.setItem("results",JSON.stringify(results));

  // Kirim ke Google Sheet
  fetch(SPREADSHEET_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({
    username:localStorage.getItem("user"),kodeSoal:"TRYOUT "+("0"+paket).slice(-2),jenisAplikasi:"UBT",skor:score,persentase:Math.round((score/100)*100),catatan:""
  })}).then(r=>r.json()).then(d=>console.log("Data Sheet:",d)).catch(e=>console.warn("POST gagal:",e));

  // Bersihkan
  localStorage.removeItem("login"); localStorage.removeItem("user"); localStorage.removeItem("paket"); localStorage.removeItem("answered"); localStorage.removeItem("time"); currentIndex=0;
  alert(`Ujian selesai!\nNilai Anda: ${score}`);
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("questionPage").classList.add("hidden");
  document.getElementById("navButtons").classList.add("hidden");
}

/* =================== INIT =================== */
window.onload=()=>{
  if(localStorage.getItem("login")==="true") login();
};
</script>

</body>
</html>
